{% extends 'base.html' %}
{% block content %}
<h2>Histórico de Incidencias</h2>
<section class="card">
<form method="get" class="filter-row">
  <label>Desde <input type="date" name="start" value="{{ start or '' }}"></label>
  <label>Hasta <input type="date" name="end" value="{{ end or '' }}"></label>
  <label>IMEI <input type="text" name="imei" value="{{ imei or '' }}" placeholder="IMEI"></label>
  <label>Nombre <input type="text" name="name" value="{{ name or '' }}" placeholder="Nombre"></label>
  <label>Por página <select name="per_page">
    {% for n in [10,20,50,100] %}
      <option value="{{ n }}" {% if per_page==n %}selected{% endif %}>{{ n }}</option>
    {% endfor %}
  </select></label>
  <button type="submit">Filtrar</button>
  <a class="btn-link" href="{{ url_for('main.export_incidents', start=start, end=end, imei=imei, name=name) }}">Exportar CSV</a>
  <a class="btn-link" href="{{ url_for('main.history_incidents') }}">Limpiar filtros</a>
</form>

<form id="bulk-form-incidents" method="post" action="{{ url_for('main.incidents_bulk_delete') }}">
  <div class="table-wrap">
  <table>
    <thead><tr><th>ID</th><th>IMEI</th><th>Reportado por</th><th>Teléfono</th><th>Archivo</th><th>Descripción</th><th>Fecha</th></tr></thead>
    <tbody>
    {% for it in items %}
    <tr style="background:var(--card-bg) !important; color:var(--text) !important">
      <td><input type="checkbox" name="selected_ids" value="{{ it.id }}"> {{ it.id }}</td>
      <td>{{ it.device_imei or (it.device.imei if it.device else '') }}</td>
      <td>{{ it.reported_by }}</td>
      <td>{{ it.phone }}</td>
      <td>{% if it.file_path %}<a href="{{ url_for('main.download_incident_file', incident_id=it.id) }}">Descargar</a>{% else %}-{% endif %}</td>
      <td>{{ it.description }}</td>
      <td>{{ it.timestamp }}</td>
    </tr>
    {% endfor %}
    </tbody>
  </table>
  </div>

  <div style="margin-top:8px">
    <input type="hidden" name="password" value="">
    <input type="hidden" name="action" value="">
    <input type="hidden" name="start" value="{{ start or '' }}">
    <input type="hidden" name="end" value="{{ end or '' }}">
    <input type="hidden" name="imei" value="{{ imei or '' }}">
    <input type="hidden" name="name" value="{{ name or '' }}">
    <input type="hidden" name="per_page" value="{{ per_page }}">
    {% if current_user.is_admin %}
      <label style="margin-right:12px"><input type="checkbox" id="select-all-incidents"> Seleccionar todo</label>
      <button type="button" id="delete-btn-incidents">Borrar seleccionados / todo</button>
    {% endif %}
  </div>
  <script>
    (function(){
      const form = document.getElementById('bulk-form-incidents')
      if(!form) return
      const selectAll = document.getElementById('select-all-incidents')
      const deleteBtn = document.getElementById('delete-btn-incidents')
      function getRowCheckboxes(){ return Array.from(form.querySelectorAll('input[name="selected_ids"]')) }
      if(selectAll){
        selectAll.addEventListener('change', function(){
          getRowCheckboxes().forEach(cb=> cb.checked = selectAll.checked)
        })
      }
      if(deleteBtn){
        deleteBtn.addEventListener('click', function(){
          const actionInput = form.querySelector('input[name="action"]')
          const passwordInput = form.querySelector('input[name="password"]')
          if(selectAll && selectAll.checked){
            actionInput.value = 'all_full'
          } else {
            const selected = getRowCheckboxes().filter(cb=>cb.checked)
            if(selected.length === 0){ alert('No hay registros seleccionados. Marca alguno o selecciona "Seleccionar todo".'); return }
            actionInput.value = 'selected_full'
          }
          const pwd = prompt('Contraseña de administrador para confirmar borrado:')
          if(!pwd){ return }
          passwordInput.value = pwd
          form.submit()
        })
      }
    })()
  </script>
  </div>
</form>

{% if pagination and pagination.pages > 1 %}
<nav class="pagination">
  {% if pagination.has_prev %}
    <a href="?page={{ pagination.prev_num }}&per_page={{ per_page }}{% if start %}&start={{ start }}{% endif %}{% if end %}&end={{ end }}{% endif %}{% if imei %}&imei={{ imei }}{% endif %}{% if name %}&name={{ name }}{% endif %}">« Anterior</a>
  {% endif %}
  <span>Página {{ pagination.page }} de {{ pagination.pages }}</span>
  {% if pagination.has_next %}
    <a href="?page={{ pagination.next_num }}&per_page={{ per_page }}{% if start %}&start={{ start }}{% endif %}{% if end %}&end={{ end }}{% endif %}{% if imei %}&imei={{ imei }}{% endif %}{% if name %}&name={{ name }}{% endif %}">Siguiente »</a>
  {% endif %}
</nav>
{% endif %}
{% endblock %}
